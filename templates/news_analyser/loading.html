{% extends 'base.html' %}

{% block content %}
<div class="container mx-auto mt-10 text-center">
    <h1 class="text-3xl font-bold mb-5">Loading...</h1>
    <div id="task-status">Starting...</div>
    <div id="progress-bar" class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
        <div id="progress" class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div>
    </div>
    <div id="result-link" class="mt-5" style="display: none;">
        <a href="" class="text-blue-500 hover:underline">View Results</a>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const taskId = "{{ task_id }}";
        const statusDiv = document.getElementById('task-status');
        const progress = document.getElementById('progress');
        const resultLink = document.getElementById('result-link').querySelector('a');
        const resultLinkDiv = document.getElementById('result-link');

        function getTaskStatus() {
            fetch(`/status/${taskId}/`)
                .then(response => response.json())
                .then(data => {
                    statusDiv.textContent = data.details.status || data.state;
                    if (data.state === 'PROGRESS') {
                        const percent = (data.details.current / data.details.total) * 100;
                        progress.style.width = percent + '%';
                    } else if (data.state === 'SUCCESS') {
                        progress.style.width = '100%';
                        // Assuming the task returns the keyword ID in the result
                        const keywordId = data.details.result;
                        resultLink.href = `/search/${keywordId}/`;
                        resultLinkDiv.style.display = 'block';
                        clearInterval(interval);
                    } else if (data.state === 'FAILURE') {
                        statusDiv.textContent = 'Task failed!';
                        clearInterval(interval);
                    }
                });
        }

        const interval = setInterval(getTaskStatus, 2000);
    });
</script>
{% endblock %}
